#Domain join

#Global 

function _query{

    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP, $QUERY
    )

    $query = az lab GET --name $LAB_NAME --resource-group $RESOURCE_GROUP  --query $QUERY -o tsv
    return $query

}

function getLabDetails {
    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP, $SEARCH_VAL
    )

    $labData = ""
    $fileName = "Lab_" + (get-Date).ToString("dd-MM-yyyy-hh-mm-ss")

    try {
        $labData = az lab GET --name $LAB_NAME --resource-group $RESOURCE_GROUP | ConvertFrom-JSON
        $labData | select * |  Export-Csv -Path  $fileName".csv"
      

    }
    catch {  }

    return $labData
}

function getJSONFields {
    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP, $SEARCH_VAL
    )

    Write-Host "lab name:" $LAB_NAME 
    Write-Host "resource group:" $RESOURCE_GROUP
    Write-Host "JSON field:" $SEARCH_VAL

    $parentField = ""
    $childField = ""
    $labData = ""

    if ($SEARCH_VAL -like '*-*') {
        $valueArray = $SEARCH_VAL -split '-'
        $parentField = $valueArray[0]
        $childField = $valueArray[1]
        $labData = az lab GET --name $LAB_NAME --resource-group $RESOURCE_GROUP | ConvertFrom-Json | select -expand $parentField | Select $childField
    }
    else {
        $labData = az lab GET --name $LAB_NAME --resource-group $RESOURCE_GROUP | ConvertFrom-Json | Select $SEARCH_VAL
    }
    if ($labData -like '*=*') {
        $returnArray = $labData -split '='
        $lastIndex = $returnArray[1].length - 1
        return $returnArray[1].SubString(0, $lastIndex)
    }
    return ""
}

function getAnnoucementEnabled {
    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
    )

    getJSONFields $LAB_NAME $RESOURCE_GROUP "announcement-enabled"
}

function getRDPConnectionType {
    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
    )

    getJSONFields $LAB_NAME $RESOURCE_GROUP "extendedProperties-RdpConnectionType"
}

#Sanity Test
function getLabCreationDate {

    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
    )

    $query = _query $LAB_NAME $RESOURCE_GROUP "createdDate"

    # Write-Host "--------------------------------" $query
    # $labDate = $query
    #$labDate = az lab GET --name dtl-dd-lab-008-neu-eng --resource-group rg-az-devtestlabs-neu-local-008  --query createdDate -o tsv
   
    # $val = $labDate -Contains 'found'
    if ($null -eq $query) {
        return $False
    }
    else{return $True}
}

#Internal Support

function internalSupport{

        param (
            [parameter(Mandatory = $true)]
            [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
        )
    
        $query = _query $LAB_NAME $RESOURCE_GROUP "support.enabled"

        if ($query -eq "Disabled") {
            return $True
        }
        else{return $False}

}

function  billingReference{
    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
    )

    $query = _query $LAB_NAME $RESOURCE_GROUP "tags.billingReference"
    return $query

}

function  opEnvironment{
    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
    )

    $query = _query $LAB_NAME $RESOURCE_GROUP "tags.opEnvironment"
    return $query

}

function  announcement{
    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
    )

    $query = _query $LAB_NAME $RESOURCE_GROUP "announcement.enabled"
    return $query

}


function  labStorageType{
    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
    )

    $query = _query $LAB_NAME $RESOURCE_GROUP "labStorageType"
    return $query

}

function rdpConnectionType{

    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
    )

    $query = _query $LAB_NAME $RESOURCE_GROUP "extendedProperties.RdpConnectionType"
    return $query
}

function cmdbReference{

    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
    )

    $query = _query $LAB_NAME $RESOURCE_GROUP "tags.cmdbReference"
    return $query
}

function vaultName{

    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]$LAB_NAME, $RESOURCE_GROUP
    )

    $query = _query $LAB_NAME $RESOURCE_GROUP "vaultName"

    
    return $query


}
#az lab GET --name dtl-dd-lab-008-neu-eng --resource-group rg-az-devtestlabs-neu-local-008 --query vaultName -o tsv
#az lab GET --name dtl-dd-lab-008-neu-eng --resource-group rg-az-devtestlabs-neu-local-008 --query support.enabled -o tsv  
