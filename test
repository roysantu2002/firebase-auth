{

  "builders": [{
    "type": "azure-arm",
    "client_id": "",
    "client_id": "dc8947bf-f0b2-440b-b829-148ebd3c3fbc",
    "client_secret": "",
    "tenant_id": "fb6ea403-7cf1-4905-810a-fe5547e98204",
    "subscription_id": "1c480ffb-0c16-4f80-bbdc-50ea81be193f",
    "managed_image_resource_group_name": "AT38995-rg-dd-teamlab-neu",
    "build_resource_group_name": "AT38995-rg-dd-teamlab-neu",
    "managed_image_name": "DTLWin10-19h2-ent-FSL-0.0.10",
    "os_type": "Windows",
    "image_publisher": "MicrosoftWindowsDesktop",
    "image_offer": "Windows-10",
    "image_sku": "19h2-ent",

    "shared_image_gallery_destination": {
      "resource_group": "AT38995-rg-dd-teamlab-neu",
      "gallery_name": "dd_team_gallery",
      "image_name": "DTL-Win10-19h-ent-FSLogix",
      "image_version": "0.0.10",
      "replication_regions": [
          "northeurope",
          "eastus2"         
      ]
  },

    "communicator": "winrm",
    "winrm_use_ssl": true,
    "winrm_insecure": true,
    "winrm_timeout": "5m",
    "winrm_username": "packer",
    "managed_image_storage_account_type": "Premium_LRS",
    "virtual_network_name": "vnt-1103-az02",
    "virtual_network_subnet_name": "user-0008",
    "private_virtual_network_with_public_ip": "False",
    "virtual_network_resource_group_name": "spoke-network-ise-appdev-1103-az02",

    "azure_tags": {
        "dept": "Engineering",
        "task": "Transmit,tls hardening,localusers"
    },

    "vm_size": "Standard_F4s_v2"
  }
  ],

  "provisioners": [
  {
      "type": "powershell",
      "timeout": "5m",
      "script": "./Scripts/Set-Env.ps1"
  },
  {
    "type": "file",
    "source": "./TransmitForWinLogon_1.04",
    "destination": "C:\\UBS"
  },
  {
    "type": "windows-shell",
    "inline": [
        "set install_mode=ins&&cmd /k C:/UBS/TransmitForWinLogon_1.04/Control.cmd"
    ]
  },
  {
    "type": "file",
    "source": "./Certs",
    "destination": "C:\\UBS"
  },
  {
    "type": "powershell",
    "timeout": "5m",
    "script": "./Scripts/Install-UBSCerts.ps1"
  },
  {
    "type": "file",
    "source": "./FSLogix",
    "destination": "C:\\UBS"
  },
  {
    "type": "file",
    "source": "./NTauthCerts",
    "destination": "C:\\UBS"
  },
  {
    "type": "file",
    "source": "./WindowsDefenderATPOnboardingPackage",
    "destination": "C:\\UBS"
  },
  {
    "type": "file",
    "source": "./UserConfig",
    "destination": "C:\\UBS"
  },
  {
    "type": "file",
    "source": "./Windows_10_VDI_Optimize",
    "destination": "C:\\UBS"
  },
  {
    "type": "windows-shell",
    "inline": [
        "cmd /c \"mkdir c:\\\\UBS\\GoogleChromeBrowser_3.43"
    ]
  },
  {
    "type": "powershell",
    "timeout": "5m",
    "script": "./Scripts/System-Conf.ps1"
  },
  {
    "type": "powershell",
    "timeout": "5m",
    "script": "./Scripts/Install-Chrome.ps1"
  },
  {
    "type": "powershell",
    "timeout": "5m",
    "script": "./Scripts/Install-FSLogix.ps1"
  },
  {
    "type": "powershell",
    "timeout": "5m",
    "inline": [
      "$currentfolder=$pwd;cd C:/UBS/FSLogix/;.\\RegisterScheduledTaskAtLogon.ps1;cd $currentfolder"
    ]
   },
  {
    "type": "powershell",
    "timeout": "30m",
    "script": "./Windows_10_VDI_Optimize/Win10_1909_VDI_Optimize.ps1"
  },
  {
    "type": "file",
    "source": "./PWBE_Security_Hardening_1.2",
    "destination": "C:\\UBS"
  },
  {
    "type": "windows-shell",
    "inline": [
      "powershell.exe -ExecutionPolicy Bypass -File C:/UBS/PWBE_Security_Hardening_1.2/Wrapper.ps1 -Features Install-Users,Create-ScheduledTask-Users"
    ]
  },
  {
    "type": "windows-shell",
    "inline": [
        "powershell.exe -ExecutionPolicy Bypass -File C:/UBS/PWBE_Security_Hardening_1.2/Wrapper.ps1 -Features Enable-TLS12,InternetExplorer-TLS,Disable-SSL2,DotNet-TLS"
    ]
  },
  {
    "type": "powershell",
    "timeout": "5m",
    "script": "./Scripts/Disable-NLA.ps1"
  },
  {
    "type": "windows-restart",
    "restart_check_command": "powershell -command \"& {Write-Output 'restarted.'}\""
  },
  {
    "type": "powershell",
    "inline": [
      "if( Test-Path $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml ){ rm $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml -Force}",
      "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
      "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
    ]
   }
  ]
}



