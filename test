
. ..\utils\vmApi.ps1

$KEY_VAULT = "kv-ddg01-neu-test"
$SECRET_SECURE = "dd-cmdb-vmstate-orchestration-url"
$KEY_VAULT_RG = "rg-ddg01-neu-test-mngmt"
# $SECRET_SECURE 

$NUM = Get-Random -Maximum 99
$PREFIXONE = ((65..90) + (97..122) | Get-Random -Count 1 | % {[char]$_}) 
$PREFIXTWON = ((65..90) + (97..122) | Get-Random -Count 1 | % {[char]$_})
$PREFIXTHREE = ((65..90) + (97..122) | Get-Random -Count 1 | % {[char]$_}) 

$VMPREFIX = "DDG-TANG-" + $PREFIXONE + $PREFIXTWON + $PREFIXTHREE

$url = az keyvault secret show --name $SECRET_SECURE --vault-name $KEY_VAULT --query value -o tsv
$urlArray = $url.Split("?")
$BASE_URL = $urlArray[0]
$CODE =  $urlArray[1]

$VMFOUND = $false
$VMSTATUS = ""


$RUN_COMMAND_URL = $BASE_URL+"/VMRunCommandWorkflow?"+$CODE
$CREATE_VM_URL = $BASE_URL+"/CreateVirtualMachineWorkflow?"+$CODE
$JOIN_DOMAIN_URL = $BASE_URL + "/JoinDomainWorkflow?"+$CODE
$APPLY_LICENSE_URL = $BASE_URL + "/ApplyLicenseWorkflow?"+$CODE
$EXP_DATE_URL = $BASE_URL + "/ExtendExpirationDateWorkflow?"+$CODE
$CREATE_DESKTOP_URL = $BASE_URL + "/desktops?"+$CODE


# $VM_NAME = $env:COMPUTERNAME

$VM_NAME = "DDG-TANG-ZNP-9S"

$EXP_DATE = "2020-12-21T23:00:00.000Z"


# $VM_NAME = "DDG-TANQ-SR-01" #"dtest01-Utkarsh"

$RESOURCE_GROUP = "rg-ddg-test01-weu-test" #"rg-ddg-test01-weu-test" #"rg-ddg-chk0-neu-prod" #"rg-ddg-team0-neu-prod" #"rg-ddg-test01-weu-test" #
$RESOURCEID =  "rg-ddg-test01-weu-test" #"rg-ddg-test01-weu-test" #"rg-ddg-test01-weu-test"
$SUBSCRIPTION = "ba-ise-ddg01-eu-appdev"
$SUBSCRIPTION_ID = "e30f1618-a35d-4a9a-88a1-82057c28c331"
$LABNAME = "ddg-test01-weu-test" #"ddg-test01-weu-test" #"ddg-team0-neu-prod" #"ddg-test01-weu-test" 
$LAB_ID = "ddg-test01-weu-test" #"ddg-test01-weu-test" #"ddg-chk0-neu-prod" #"ddg-test01-weu-test" #"ddg-team0-neu-prod"

#----Other details
$MAX_DURATION = 2
$SCRIPT = "echo hello world \n echo hello world"
$DOMAIN_FQDN = "UBSCLOUD-PROD.msad.ubs.net"
$DOMAIN_USER_NAME = "santu.roy@ubs.com"
$OUPATH = "" 


$NUM = Get-Random -Maximum 99
$PREFIXONE = ((65..90) + (97..122) | Get-Random -Count 1 | % {[char]$_}) 
$PREFIXTWON = ((65..90) + (97..122) | Get-Random -Count 1 | % {[char]$_})
$PREFIXTHREE = ((65..90) + (97..122) | Get-Random -Count 1 | % {[char]$_}) 

$VMPREFIX = "DDG-TANG-" + $PREFIXONE + $PREFIXTWON + $PREFIXTHREE

$url = az keyvault secret show --name $SECRET_SECURE --vault-name $KEY_VAULT --query value -o tsv
$urlArray = $url.Split("?")
$BASE_URL = $urlArray[0]
$CODE =  $urlArray[1]

$VMFOUND = $false
$VMSTATUS = ""

$RUN_COMMAND_URL = $BASE_URL+"/VMRunCommandWorkflow?"+$CODE
$CREATE_VM_URL = $BASE_URL+"/CreateVirtualMachineWorkflow?"+$CODE
$JOIN_DOMAIN_URL = $BASE_URL + "/JoinDomainWorkflow?"+$CODE
$APPLY_LICENSE_URL = $BASE_URL + "/ApplyLicenseWorkflow?"+$CODE
$ADD_USER_URL = $BASE_URL + "/AddUserToVmWorkflow?"+$CODE 
# $VM_NAME = $env:COMPUTERNAME

# $VM_NAME = "dtest01-Utkarsh"
# $USER_UPN = "andrew.numa@ubs.com"
# $RESOURCE_GROUP = "rg-ddg-test01-weu-test" #"rg-ddg-team0-neu-prod"
# $RESOURCEID = "rg-ddg-test01-weu-test" #"rg-ddg-team0-neu-prod"
$SUBSCRIPTION = "ba-ise-ddg01-eu-appdev"
$SUBSCRIPTION_ID = "e30f1618-a35d-4a9a-88a1-82057c28c331"
$MAX_DURATION = 2
$SCRIPT = "echo hello world \n echo hello world"
$DOMAIN_FQDN = "UBSCLOUD-PROD.msad.ubs.net"
$DOMAIN_USER_NAME = "santu.roy@ubs.com"
$OUPATH = "" 
# $LABNAME = "ddg-team0-neu-prod"

#Variables for desktop
$USERUPNS = "santu.roy@ubs.com (santu.roy%40ubs.com)"
$PKG_SETS = "['developer-core']"
